name: Pull Request - Build and Scan

on:
  pull_request:
    paths:
      - "managed-containers/**"

permissions: read-all

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.mk-matrix.outputs.matrix }}
      count:  ${{ steps.mk-matrix.outputs.count }}
    steps:
      - name: Checkout
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0

      - name: Compute changed files (JSON, NUL-safe)
        id: changed
        run: |
          set -euo pipefail
          base="${{ github.event.pull_request.base.sha }}"
          head="${{ github.sha }}"

          # Use -z for NUL-delimited robustness; also filter to managed-containers/**
          changed_files_json="$(
            git diff --name-only -z "$base" "$head" -- 'managed-containers/**' \
            | jq -Rs 'split("\u0000") | map(select(length>0))'
          )"

          echo "Changed files JSON:"
          echo "$changed_files_json" | jq '.'

          {
            echo 'changed_files<<__JSON__'
            echo "$changed_files_json"
            echo '__JSON__'
          } >> "$GITHUB_OUTPUT"